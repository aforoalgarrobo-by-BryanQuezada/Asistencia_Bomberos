<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Lector QR – Cuartel 2</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1020;color:#e9ecff}
.wrap{max-width:900px;margin:24px auto;padding:0 16px}
h1{margin:8px 0 4px}.sub{color:#9aa3c7;margin:0 0 16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
button{background:#36d399;color:#0b1020;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn-alt{background:#1f2b63;color:#e9ecff}
.pill{border:1px solid #2a356a;background:#0f1633;border-radius:999px;padding:6px 10px;cursor:pointer}
.active{outline:2px solid #36d399}
#reader{width:100%;max-width:520px;aspect-ratio:3/4;background:#000;border-radius:12px;overflow:hidden}
.log{background:#0f1633;border:1px solid #2a356a;border-radius:10px;padding:10px;min-height:56px}
.ok{color:#36d399}.bad{color:#ef4444}
.frase{margin-top:6px;color:#cfe7ff}
small{color:#9aa3c7}
</style>
</head>
<body>

<!-- ==== BLOQUEO POR CLAVE (frontend) ==== -->
<div id="lockScreen" style="
  position:fixed; inset:0; z-index:9999;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(120deg,#0b1020,#0e1430); color:#e9ecff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
">
  <div style="
    width:min(420px,92vw);
    background:#111735; border:1px solid #2a356a;
    border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);
  ">
    <h2 style="margin:0 0 6px">Acceso restringido</h2>
    <p style="margin:0 0 14px; color:#9aa3c7">Ingresa la contraseña para ver esta página.</p>

    <input id="lockPass" type="password" placeholder="Contraseña"
      style="width:100%; padding:12px; border-radius:10px; border:1px solid #2a356a; background:#0f1633; color:#e9ecff;" />

    <button id="lockBtn" style="
      margin-top:12px; width:100%;
      background:#36d399; color:#0b1020; border:none;
      padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer
    ">Entrar</button>

    <div id="lockMsg" style="margin-top:10px; color:#ef4444; font-size:13px; display:none">
      Contraseña incorrecta
    </div>
  </div>
</div>

<div class="wrap">
  <h1>Lector QR – Cuartel 2</h1>
  <p class="sub">Escanea un QR (ID). Suena un beep al leer, reproduce frase personalizada si existe (si no, usa “Bienvenido/Hasta pronto”), y registra Entrada/Salida (modo aforo, sin op=next).</p>

  <div class="row">
    <span>Motivo:</span>
    <span class="pill active" data-m="Guardia">Guardia</span>
    <span class="pill" data-m="Academia">Academia</span>
    <span class="pill" data-m="Curso">Curso</span>
    <span class="pill" data-m="Reunión">Reunión</span>
    <span class="pill" data-m="Visita">Visita</span>
  </div>

  <div id="reader"></div>

  <div class="row" style="margin-top:12px">
    <button id="startBtn">Iniciar cámara</button>
    <button id="stopBtn" class="btn-alt">Detener</button>
    <button id="switchBtn" class="btn-alt">Cambiar</button>
  </div>

  <div class="log" id="log">Listo.</div>
  <div class="frase" id="frase">—</div>
  <div style="margin-top:8px">
    <small>Nota: Entrada/Salida se decide con memoria local del equipo (igual que tu página de aforo).</small>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== Configura esto ===== */
const CUARTEL_NAME = "Cuartel 2";
const API_BASE = "https://script.google.com/macros/s/AKfycbyVI7DnS7YHSxYyPQ42dmnKQK9py90iCGnT0HMILFx-Q-_OzuTVXLrVY9CHKP-Jk0Gz/exec";
const SCAN_COOLDOWN_MS = 5000;
/* ========================== */

const logEl = document.getElementById('log');
const fraseEl = document.getElementById('frase');

let currentMotivo = "Guardia";
document.querySelectorAll('.pill').forEach(p=>{
  p.addEventListener('click', ()=>{
    document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active');
    currentMotivo = p.dataset.m;
  });
});

/* ==== JSONP (igual estilo aforo) ==== */
function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ resolve(data); try{ delete window[cb]; }catch{} };
    const s = document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
    s.onerror = ()=> reject(new Error('JSONP error'));
    document.body.appendChild(s);
    setTimeout(()=>{ try{s.remove()}catch{} }, 12000);
  });
}

/* ==== Voz ==== */
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "es-CL";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch{}
}

/* ==== Beep (WebAudio) ==== */
let audioCtx = null;
function beep(ok=true){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = ok ? 880 : 220;       // OK = agudo / FAIL = grave
    g.gain.value = 0.06;

    o.connect(g);
    g.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    o.start(now);
    o.stop(now + (ok ? 0.08 : 0.15));
  }catch{}
}

/* ==== Antirréplica ==== */
const lastScanAt = new Map();
function canAccept(id){
  const t=Date.now(), last=lastScanAt.get(id)||0;
  if (t-last < SCAN_COOLDOWN_MS) return false;
  lastScanAt.set(id,t);
  return true;
}

/* ==== Estado local Entrada/Salida (igual que aforo) ==== */
function localKey(id){ return `inside_${CUARTEL_NAME}_${id}`; }
function getLocalInside(id){ return localStorage.getItem(localKey(id)) === "1"; }
function setLocalInside(id, v){ localStorage.setItem(localKey(id), v ? "1" : "0"); }

/* ==== Extraer ID del QR (texto simple o JSON {id:"..."}) ==== */
function extractIdFromQr(text){
  try{
    const obj = JSON.parse(text);
    if (obj && obj.id) return String(obj.id).trim().toUpperCase();
  }catch{}
  return String(text||"").trim().toUpperCase();
}

/* ==== Construir frase: personalizada si existe; si no, por defecto ==== */
function buildFrase_(accion, b){
  const cargo  = (b?.cargo  || "").toString().trim();
  const nombre = (b?.nombre || "").toString().trim();

  // 1) Preferir personalizada (si existe)
  const bienv = (b?.bienvenida || "").toString().trim();
  const desped = (b?.despedida || "").toString().trim();

  if (accion === "Entrada" && bienv) return bienv;
  if (accion === "Salida"  && desped) return desped;

  // 2) Default solicitado
  if (accion === "Entrada") return `Bienvenido ${cargo} ${nombre}`.trim();
  return `Hasta pronto ${cargo} ${nombre}`.trim();
}

/* ==== Flujo principal (sin op=next) ==== */
async function registrarPorId(idPlano, motivoSel){
  const id = (idPlano||"").trim().toUpperCase();
  const motivo = motivoSel || "Guardia";
  if (!id){ logEl.textContent="ID vacío"; beep(false); return; }

  try{
    logEl.textContent = "Buscando bombero…";
    fraseEl.textContent = "—";

    // 1) Traer bomberos (como aforo)
    const bom = await jsonp(API_BASE + "?op=bomberos");
    const b = bom[id];
    if (!b){
      logEl.innerHTML = `<span class="bad">❌ ID no encontrado en hoja Bomberos (${id})</span>`;
      fraseEl.textContent = "—";
      beep(false);
      return;
    }

    // 2) Decidir acción con estado local
    const wasInside = getLocalInside(id);
    const accion = wasInside ? "Salida" : "Entrada";

    // 3) Frase
    const frase = buildFrase_(accion, b);
    fraseEl.textContent = frase;

    // 4) Registrar
    logEl.textContent = "Registrando " + accion + "…";
    const url = `${API_BASE}?id=${encodeURIComponent(id)}&nombre=${encodeURIComponent(b.nombre||"")}&cargo=${encodeURIComponent(b.cargo||"")}&cuartel=${encodeURIComponent(CUARTEL_NAME)}&accion=${encodeURIComponent(accion)}&motivo=${encodeURIComponent(motivo)}`;
    const res = await fetch(url, { cache: "no-store" });
    const txt = await res.text();

    if (txt.includes("OK")){
      // sonido + voz SOLO si fue OK
      beep(true);
      speak(frase);

      // alternar estado local
      setLocalInside(id, !wasInside);

      logEl.innerHTML = `<span class="ok">✅ OK: ${accion} para ${b.nombre || id}</span>`;
    } else {
      beep(false);
      logEl.innerHTML = `<span class="bad">⚠️ Error: ${txt}</span>`;
    }
  }catch(e){
    console.error(e);
    beep(false);
    logEl.innerHTML = '<span class="bad">❌ Error de conexión</span>';
  }
}

/* ==== Cámara (html5-qrcode) ==== */
const html5QrCode = new Html5Qrcode("reader");
let currentCameraId = null;

async function startCamera(){
  try{
    logEl.textContent="Solicitando cámara…";
    const devices = await Html5Qrcode.getCameras();
    if (!devices || !devices.length){
      logEl.innerHTML='<span class="bad">No hay cámaras</span>'; return;
    }
    currentCameraId = currentCameraId || (devices.find(d=>/back|rear|environment/i.test(d.label))?.id || devices[0].id);

    await html5QrCode.start(
      { deviceId: { exact: currentCameraId } },
      { fps: 10, qrbox: { width: 300, height: 300 } },
      onScanSuccess,
      onScanError
    );

    logEl.textContent="Cámara activa. Escanea un QR.";
  }catch(e){
    console.error(e);
    logEl.innerHTML = '<span class="bad">No se pudo iniciar la cámara</span>';
  }
}

async function stopCamera(){
  try{ await html5QrCode.stop(); logEl.textContent="Cámara detenida."; }catch{}
}

async function switchCamera(){
  try{
    const devices = await Html5Qrcode.getCameras();
    if (!devices || devices.length<2){ logEl.textContent="No hay otra cámara"; return; }
    const idx = devices.findIndex(d=>d.id===currentCameraId);
    const next = devices[(idx+1)%devices.length];
    await html5QrCode.stop();
    currentCameraId = next.id;
    await startCamera();
  }catch(e){ console.error(e); }
}

function onScanSuccess(decodedText){
  // beep inmediato para confirmar lectura (aunque después falle el registro)
  beep(true);

  const id = extractIdFromQr(decodedText);
  if(!id){
    logEl.innerHTML='<span class="bad">QR sin ID</span>';
    beep(false);
    return;
  }
  if(!canAccept(id)) return;

  registrarPorId(id, currentMotivo);
}
function onScanError(){ /* ignorar */ }

/* ==== Botones ==== */
document.getElementById('startBtn').addEventListener('click', startCamera);
document.getElementById('stopBtn').addEventListener('click', stopCamera);
document.getElementById('switchBtn').addEventListener('click', switchCamera);

/* ==== PASSWORD GATE (sin autoguardado) ==== */
const PAGE_PASSWORD = "CBA01041954";
function lockInit(){
  const ls = document.getElementById("lockScreen");
  if (!ls) return;

  ls.style.display = "flex";
  const input = document.getElementById("lockPass");
  const btn = document.getElementById("lockBtn");
  const msg = document.getElementById("lockMsg");

  function unlock(){ ls.style.display = "none"; }
  function tryLogin(){
    const p = (input.value || "").trim();
    if (p === PAGE_PASSWORD){
      if (msg) msg.style.display = "none";
      unlock();
    } else {
      if (msg) msg.style.display = "block";
      input.focus();
      input.select();
    }
  }

  btn.addEventListener("click", tryLogin);
  input.addEventListener("keydown", (ev)=>{ if (ev.key === "Enter") tryLogin(); });
}
document.addEventListener("DOMContentLoaded", lockInit);
</script>
</body>
</html>
