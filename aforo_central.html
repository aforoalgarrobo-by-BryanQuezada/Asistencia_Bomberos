<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aforo ‚Äì Central (Solo lectura)</title>
<style>
  :root{ --bg:#0b1020; --card:#111735; --ink:#e9ecff; --muted:#9aa3c7; --accent:#36d399; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(120deg,#0b1020,#0e1430); color:var(--ink);}
  .wrap{max-width:1400px; margin:40px auto; padding:0 16px;}
  h1{font-size:clamp(22px,3.5vw,34px); margin:0 0 8px}
  .sub{color:var(--muted); margin:0 0 24px}
  .grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px;}
  .card{background:var(--card); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .head{display:flex; align-items:center; gap:12px; margin-bottom:6px}
  .logo-cu{width:60px; height:60px; object-fit:contain; border-radius:10px; background:#0f1633; border:1px solid #2a356a}
  .label{color:var(--muted); font-size:13px; margin-bottom:6px}
  .value{font-size:50px; font-weight:800; line-height:1; margin-bottom:6px}
  .name{font-size:13px; opacity:.9}
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
  .chip{ background:#0f1633; border:1px solid #2a356a; color:#e9ecff; padding:4px 10px; border-radius:9999px; font-size:12px; }
  .chip .dot{ width:8px; height:8px; background:var(--accent); border-radius:9999px; display:inline-block; margin-right:6px; vertical-align:middle; }
  .footer{margin-top:10px; color:var(--muted); font-size:12px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 20px}
  button{background:var(--accent); color:#0b1020; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer}
  .led{width:10px; height:10px; border-radius:999px; background:#555}
  .led.ok{background:#36d399}
  .led.bad{background:#ef4444}

  /* ===== Presentes dentro de cada card ===== */
  .presentes-wrap{ margin-top:10px; }
  .presentes-title{ color:var(--muted); font-size:13px; margin-top:10px; }
  .presentes-list{
    margin-top:6px;
    border:1px solid #2a356a;
    background:#0f1633;
    border-radius:12px;
    overflow:hidden;
    max-height:220px;
    overflow:auto;
  }
  .pres-row{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border-bottom:1px solid rgba(42,53,106,.6);
    font-size:13px;
  }
  .pres-row:last-child{ border-bottom:none; }
  .pres-name{ font-weight:800; }
  .pres-cargo{ color:var(--muted); font-size:12px; white-space:nowrap; }
  .pres-empty{
    padding:10px 12px;
    color:var(--muted);
    font-size:13px;
  }
</style>
</head>
<body>
  <!-- ==== BLOQUEO POR CLAVE (frontend) ==== -->
<div id="lockScreen" style="
  position:fixed; inset:0; z-index:9999;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(120deg,#0b1020,#0e1430); color:#e9ecff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
">
  <div style="
    width:min(420px,92vw);
    background:#111735; border:1px solid #2a356a;
    border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);
  ">
    <h2 style="margin:0 0 6px">Acceso restringido</h2>
    <p style="margin:0 0 14px; color:#9aa3c7">Ingresa la contrase√±a para ver esta p√°gina.</p>

    <input id="lockPass" type="password" placeholder="Contrase√±a"
      style="width:100%; padding:12px; border-radius:10px; border:1px solid #2a356a; background:#0f1633; color:#e9ecff;" />

    <button id="lockBtn" style="
      margin-top:12px; width:100%;
      background:#36d399; color:#0b1020; border:none;
      padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer
    ">Entrar</button>

    <div id="lockMsg" style="margin-top:10px; color:#ef4444; font-size:13px; display:none">
      Contrase√±a incorrecta
    </div>
  </div>
</div>

  <div class="wrap">
    <h1>Central ‚Äì Aforo y Estado (Solo lectura)</h1>
    <p class="sub">Vista consolidada de los cuatro cuarteles.</p>

    <div class="row">
      <button id="refreshBtn">Actualizar ahora</button>
      <span id="status" class="sub">Esperando datos‚Ä¶</span>
      <span id="led" class="led"></span>
    </div>

    <div class="grid" id="grid"></div>

    <div class="card" style="margin-top:16px">
      <div class="label">Total en planta</div>
      <div id="tot" class="value" style="color:var(--accent)">0</div>
      <div class="footer" id="updated">Actualizado: ‚Äî</div>
    </div>
  </div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbyVI7DnS7YHSxYyPQ42dmnKQK9py90iCGnT0HMILFx-Q-_OzuTVXLrVY9CHKP-Jk0Gz/exec";
  const LOGOS = {
    "Cuartel 1": "img/c1.png",
    "Cuartel 2": "img/c2.png",
    "Cuartel 3": "img/c3.png",
    "Cuartel General": "img/cg.png",
  };
  const CUARTELES = ["Cuartel 1","Cuartel 2","Cuartel 3","Cuartel General"];

  const grid = document.getElementById('grid');
  const el = {
    status: document.getElementById('status'),
    led: document.getElementById('led'),
    btn: document.getElementById('refreshBtn'),
    updated: document.getElementById('updated'),
    tot: document.getElementById('tot'),
  };

  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      window[cb]=d=>{resolve(d);try{delete window[cb]}catch{}};
      const s=document.createElement('script');
      s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_='+Date.now();
      s.onerror=()=>reject(new Error('JSONP error'));
      document.body.appendChild(s);
      setTimeout(()=>{try{s.remove()}catch{}},12000);
    });
  }

  function renderChips(container, list){
    container.innerHTML = "";
    (list||[]).forEach(txt=>{
      const chip=document.createElement('span');
      chip.className='chip';
      chip.innerHTML='<span class="dot"></span>'+escapeHtml(txt);
      container.appendChild(chip);
    });
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function buildCards(){
    grid.innerHTML="";
    CUARTELES.forEach(cu=>{
      const card=document.createElement('div');
      card.className='card';
      const logo=LOGOS[cu]||"img/logocuerpo.png";

      card.innerHTML=`
        <div class="head">
          <img class="logo-cu" src="${logo}" alt="${cu}">
          <div>
            <div class="label">${cu}</div>
            <div class="value" id="cnt-${cu}">0</div>
            <div class="name">Voluntarios dentro</div>
          </div>
        </div>

        <div class="name">Cuartelero: <b id="view-cu-${cu}">‚Äî</b></div>
        <div class="name" style="margin-top:4px">Conductor: <b id="view-co-${cu}">‚Äî</b></div>

        <div class="label" style="margin-top:8px">Unidades activas</div>
        <div id="chips-${cu}" class="chips"></div>

        <!-- üëá Aqu√≠ se agregan los presentes -->
        <div class="presentes-wrap">
          <div class="presentes-title">Presentes (Nombre / Cargo)</div>
          <div id="pres-${cu}" class="presentes-list">
            <div class="pres-empty">Cargando‚Ä¶</div>
          </div>
        </div>

        <div class="footer" id="saved-${cu}">‚Äî</div>
      `;
      grid.appendChild(card);
    });
  }

  async function loadAforo(){
    try{
      el.status.textContent="Actualizando‚Ä¶";
      el.led.classList.remove('bad'); el.led.classList.add('ok');

      const data = await jsonp(API_BASE+"?op=aforo");
      const counts = data.counts || {};
      let total = 0;

      CUARTELES.forEach(cu=>{
        const v = counts[cu] || 0;
        total += v;
        const n = document.getElementById('cnt-'+cu);
        if (n) n.textContent = v;
      });

      el.tot.textContent = total;
      el.updated.textContent = "Actualizado: " + (data.updated || new Date().toLocaleString("es-CL"));
      el.status.textContent="OK";
    }catch(e){
      console.error(e);
      el.status.textContent="Error";
      el.led.classList.remove('ok'); el.led.classList.add('bad');
    }
  }

  async function loadEstado(){
    const est = await jsonp(API_BASE + "?op=estado");
    CUARTELES.forEach(cu=>{
      const e = est[cu] || {cuartelero:"", conductor:"", unidades:[], updated:""};
      const vcu = document.getElementById(`view-cu-${cu}`);
      const vco = document.getElementById(`view-co-${cu}`);
      if (vcu) vcu.textContent = e.cuartelero || "‚Äî";
      if (vco) vco.textContent = e.conductor  || "‚Äî";
      renderChips(document.getElementById(`chips-${cu}`), e.unidades);

      const saved = document.getElementById(`saved-${cu}`);
      if (saved) saved.textContent = e.updated ? ("√öltima actualizaci√≥n: " + e.updated) : "‚Äî";
    });
  }

  function renderPresentes(cu, list){
    const box = document.getElementById(`pres-${cu}`);
    if (!box) return;

    box.innerHTML = "";

    const arr = Array.isArray(list) ? list : [];
    if (!arr.length){
      box.innerHTML = `<div class="pres-empty">‚Äî Sin presentes ‚Äî</div>`;
      return;
    }

    arr.forEach(p=>{
      const row = document.createElement('div');
      row.className = "pres-row";
      row.innerHTML = `
        <div class="pres-name">${escapeHtml(p.nombre || "")}</div>
        <div class="pres-cargo">${escapeHtml(p.cargo || "")}</div>
      `;
      box.appendChild(row);
    });
  }

  async function loadPresentes(){
    try{
      const data = await jsonp(API_BASE + "?op=presentes");
      const byCu = (data && data.cuarteles) ? data.cuarteles : {};
      CUARTELES.forEach(cu=>{
        renderPresentes(cu, byCu[cu] || []);
      });
    }catch(e){
      console.error(e);
      CUARTELES.forEach(cu=>{
        const box = document.getElementById(`pres-${cu}`);
        if (box) box.innerHTML = `<div class="pres-empty">‚ùå Error cargando presentes</div>`;
      });
    }
  }

  el.btn.addEventListener('click', ()=>{
    loadAforo(); loadEstado(); loadPresentes();
  });

  (async function init(){
    buildCards();
    await loadAforo();
    await loadEstado();
    await loadPresentes();

    setInterval(loadAforo, 5000);
    setInterval(loadEstado, 10000);
    setInterval(loadPresentes, 7000);
  })();
  /* ==== PASSWORD GATE (simple) ==== */
// Cambia la clave aqu√≠ (una por p√°gina si quieres)
const PAGE_PASSWORD = "CBA01041954";

// Guarda acceso por 12 horas en este dispositivo/navegador
const LOCK_KEY = "aforo_auth_until";
const AUTH_HOURS = 12;

function isAuthed(){
  const until = Number(localStorage.getItem(LOCK_KEY) || "0");
  return Date.now() < until;
}

function unlock(){
  const until = Date.now() + AUTH_HOURS * 60 * 60 * 1000;
  localStorage.setItem(LOCK_KEY, String(until));
  const ls = document.getElementById("lockScreen");
  if (ls) ls.style.display = "none";
}

function lockInit(){
  const ls = document.getElementById("lockScreen");
  if (!ls) return;

  if (isAuthed()){
    ls.style.display = "none";
    return;
  }

  const input = document.getElementById("lockPass");
  const btn = document.getElementById("lockBtn");
  const msg = document.getElementById("lockMsg");

  function tryLogin(){
    const p = (input.value || "").trim();
    if (p === PAGE_PASSWORD){
      if (msg) msg.style.display = "none";
      unlock();
    } else {
      if (msg) msg.style.display = "block";
      input.focus();
      input.select();
    }
  }

  btn.addEventListener("click", tryLogin);
  input.addEventListener("keydown", (ev)=>{ if (ev.key === "Enter") tryLogin(); });
}
lockInit();

</script>
</body>
</html>
