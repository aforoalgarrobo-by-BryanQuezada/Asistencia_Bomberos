<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aforo – Central (Solo lectura)</title>
<style>
  :root{ --bg:#0b1020; --card:#111735; --ink:#e9ecff; --muted:#9aa3c7; --accent:#36d399; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(120deg,#0b1020,#0e1430); color:var(--ink);}
  .wrap{max-width:1400px; margin:40px auto; padding:0 16px;}
  h1{font-size:clamp(22px,3.5vw,34px); margin:0 0 8px}
  .sub{color:var(--muted); margin:0 0 24px}
  .grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px;}
  .card{background:var(--card); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .head{display:flex; align-items:center; gap:12px; margin-bottom:6px}
  .logo-cu{width:60px; height:60px; object-fit:contain; border-radius:10px; background:#0f1633; border:1px solid #2a356a}
  .label{color:var(--muted); font-size:13px; margin-bottom:6px}
  .value{font-size:50px; font-weight:800; line-height:1; margin-bottom:6px}
  .name{font-size:13px; opacity:.9}
  .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
  .chip{ background:#0f1633; border:1px solid #2a356a; color:#e9ecff; padding:4px 10px; border-radius:9999px; font-size:12px; }
  .chip .dot{ width:8px; height:8px; background:var(--accent); border-radius:9999px; display:inline-block; margin-right:6px; vertical-align:middle; }
  .footer{margin-top:10px; color:var(--muted); font-size:12px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 20px}
  button{background:var(--accent); color:#0b1020; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer}
  .led{width:10px; height:10px; border-radius:999px; background:#555}
  .led.ok{background:#36d399}
  .led.bad{background:#ef4444}

  /* ===== Presentes ===== */
  .presentes-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-top:16px;}
  .table{width:100%; border-collapse:collapse; margin-top:10px; overflow:hidden; border-radius:12px; border:1px solid #2a356a;}
  .table th,.table td{padding:10px 10px; font-size:13px; border-bottom:1px solid #1c2554;}
  .table th{color:var(--muted); text-align:left; background:#0f1633;}
  .table tr:last-child td{border-bottom:none;}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:4px 10px; border-radius:999px; background:#0f1633; border:1px solid #2a356a; font-size:12px; color:var(--ink);}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);display:inline-block}
  .empty{color:var(--muted); font-size:13px; margin-top:8px;}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Central – Aforo y Estado (Solo lectura)</h1>
    <p class="sub">Vista consolidada de los cuatro cuarteles.</p>

    <div class="row">
      <button id="refreshBtn">Actualizar ahora</button>
      <span id="status" class="sub">Esperando datos…</span>
      <span id="led" class="led"></span>
    </div>

    <div class="grid" id="grid"></div>

    <div class="card" style="margin-top:16px">
      <div class="label">Total en planta</div>
      <div id="tot" class="value" style="color:var(--accent)">0</div>
      <div class="footer" id="updated">Actualizado: —</div>
    </div>

    <!-- ===== Panel nuevo: Presentes por cuartel ===== -->
    <div class="card" style="margin-top:16px">
      <div class="label">Presentes por cuartel</div>
      <div class="name">Listado sincronizado con el aforo (solo quienes cuentan en aforo).</div>
      <div class="footer" id="presentes-updated">Actualizado: —</div>
      <div class="presentes-grid" id="presentes-grid"></div>
    </div>
  </div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbxwXPZt7vKDBnpN1yhb5DYjzaeKNvEhrneTgsZQRBN0Mlv7z6CX_gUN0cHaJkUx2VMI/exec";   // ← tu /exec
  const LOGOS = {
    "Cuartel 1": "img/c1.png",
    "Cuartel 2": "img/c2.png",
    "Cuartel 3": "img/c3.png",
    "Cuartel General": "img/cg.png",
  };
  const CUARTELES = ["Cuartel 1","Cuartel 2","Cuartel 3","Cuartel General"];

  const grid = document.getElementById('grid');
  const el = {
    status: document.getElementById('status'),
    led: document.getElementById('led'),
    btn: document.getElementById('refreshBtn'),
    updated: document.getElementById('updated'),
    tot: document.getElementById('tot'),
    presentesGrid: document.getElementById('presentes-grid'),
    presentesUpdated: document.getElementById('presentes-updated'),
  };

  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb="cb_"+Math.random().toString(36).slice(2);
      window[cb]=d=>{resolve(d);try{delete window[cb]}catch{}};
      const s=document.createElement('script');
      s.src=url+(url.includes('?')?'&':'?')+'callback='+cb+'&_='+Date.now();
      s.onerror=()=>reject(new Error('JSONP error'));
      document.body.appendChild(s);
      setTimeout(()=>{try{s.remove()}catch{}},12000);
    });
  }

  function renderChips(container, list){
    container.innerHTML = "";
    (list||[]).forEach(txt=>{
      const chip=document.createElement('span');
      chip.className='chip';
      chip.innerHTML='<span class="dot"></span>'+txt;
      container.appendChild(chip);
    });
  }

  function buildCards(){
    grid.innerHTML="";
    CUARTELES.forEach(cu=>{
      const card=document.createElement('div');
      card.className='card';
      const logo=LOGOS[cu]||"img/logocuerpo.png";
      card.innerHTML=`
        <div class="head">
          <img class="logo-cu" src="${logo}" alt="${cu}">
          <div>
            <div class="label">${cu}</div>
            <div class="value" id="cnt-${cu}">0</div>
            <div class="name">Voluntarios dentro</div>
          </div>
        </div>
        <div class="name">Cuartelero: <b id="view-cu-${cu}">—</b></div>
        <div class="name" style="margin-top:4px">Conductor: <b id="view-co-${cu}">—</b></div>
        <div class="label" style="margin-top:8px">Unidades activas</div>
        <div id="chips-${cu}" class="chips"></div>
        <div class="footer" id="saved-${cu}">—</div>
      `;
      grid.appendChild(card);
    });
  }

  async function loadAforo(){
    try{
      el.status.textContent="Actualizando…";
      el.led.classList.remove('bad'); el.led.classList.add('ok');

      const data = await jsonp(API_BASE+"?op=aforo");
      const counts = data.counts || {};
      let total = 0;

      CUARTELES.forEach(cu=>{
        const v = counts[cu] || 0;
        total += v;
        const n = document.getElementById('cnt-'+cu);
        if (n) n.textContent = v;
      });

      el.tot.textContent = total;
      el.updated.textContent = "Actualizado: " + (data.updated || new Date().toLocaleString("es-CL"));
      el.status.textContent="OK";
    }catch(e){
      console.error(e);
      el.status.textContent="Error";
      el.led.classList.remove('ok'); el.led.classList.add('bad');
    }
  }

  async function loadEstado(){
    const est = await jsonp(API_BASE + "?op=estado");
    CUARTELES.forEach(cu=>{
      const e = est[cu] || {cuartelero:"", conductor:"", unidades:[], updated:""};
      const vcu = document.getElementById(`view-cu-${cu}`);
      const vco = document.getElementById(`view-co-${cu}`);
      if (vcu) vcu.textContent = e.cuartelero || "—";
      if (vco) vco.textContent = e.conductor  || "—";
      renderChips(document.getElementById(`chips-${cu}`), e.unidades);
      const saved = document.getElementById(`saved-${cu}`);
      if (saved) saved.textContent = e.updated ? ("Última actualización: " + e.updated) : "—";
    });
  }

  function renderPresentesTable(cuartel, list){
    const card = document.createElement('div');
    card.className = 'card';

    const logo = LOGOS[cuartel] || "img/logocuerpo.png";
    const count = (list||[]).length;

    card.innerHTML = `
      <div class="head">
        <img class="logo-cu" src="${logo}" alt="${cuartel}">
        <div>
          <div class="label">${cuartel}</div>
          <div class="pill"><span class="dot"></span> ${count} presentes</div>
        </div>
      </div>
    `;

    if (!list || list.length === 0){
      const empty = document.createElement('div');
      empty.className = 'empty';
      empty.textContent = "— Sin presentes —";
      card.appendChild(empty);
      return card;
    }

    const table = document.createElement('table');
    table.className = 'table';
    table.innerHTML = `
      <thead>
        <tr>
          <th style="width:55%">Nombre</th>
          <th style="width:45%">Cargo</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');
    list.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(p.nombre || "")}</td>
        <td>${escapeHtml(p.cargo || "")}</td>
      `;
      tbody.appendChild(tr);
    });

    card.appendChild(table);
    return card;
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadPresentes(){
    try{
      const data = await jsonp(API_BASE + "?op=presentes");
      const byCu = (data && data.cuarteles) ? data.cuarteles : {};
      el.presentesUpdated.textContent = "Actualizado: " + (data.updated || new Date().toLocaleString("es-CL"));

      el.presentesGrid.innerHTML = "";
      CUARTELES.forEach(cu=>{
        const list = byCu[cu] || [];
        el.presentesGrid.appendChild(renderPresentesTable(cu, list));
      });
    } catch (e){
      console.error(e);
      el.presentesUpdated.textContent = "Actualizado: — (error)";
      el.presentesGrid.innerHTML = `<div class="empty">❌ Error cargando presentes</div>`;
    }
  }

  el.btn.addEventListener('click', ()=>{
    loadAforo(); loadEstado(); loadPresentes();
  });

  (async function init(){
    buildCards();
    await loadAforo();
    await loadEstado();
    await loadPresentes();
    setInterval(loadAforo, 5000);
    setInterval(loadEstado, 10000);
    setInterval(loadPresentes, 7000);
  })();
</script>
</body>
</html>
