<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Central – Presentes por Cuartel</title>
<style>
  :root{ --bg:#0b1020; --card:#111735; --ink:#e9ecff; --muted:#9aa3c7; --accent:#36d399; --danger:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(120deg,#0b1020,#0e1430); color:var(--ink);}
  .wrap{max-width:1200px; margin:40px auto; padding:0 16px;}
  h1{font-size:clamp(22px,3.5vw,34px); margin:0 0 8px}
  .sub{color:var(--muted); margin:0 0 18px}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:10px 0 20px}
  button{background:var(--accent); color:#0b1020; border:none; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer}
  .pill{display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid #2a356a; background:#0f1633; font-size:12px; color:var(--ink)}
  .led{width:10px; height:10px; border-radius:999px; background:#555}
  .led.ok{background:var(--accent)}
  .led.bad{background:var(--danger)}
  .grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:16px;}
  .card{background:var(--card); border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
  .head{display:flex; align-items:center; gap:12px; margin-bottom:10px}
  .logo-cu{width:54px; height:54px; object-fit:contain; border-radius:10px; background:#0f1633; border:1px solid #2a356a}
  .title{display:flex; flex-direction:column; gap:2px}
  .label{color:var(--muted); font-size:13px}
  .count{font-size:34px; font-weight:900; line-height:1}
  .list{margin-top:10px; display:flex; flex-direction:column; gap:8px}
  .item{background:#0f1633; border:1px solid #2a356a; border-radius:12px; padding:10px}
  .name{font-weight:800}
  .meta{color:var(--muted); font-size:12px; margin-top:2px}
  .footer{margin-top:14px; color:var(--muted); font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Central – Presentes por Cuartel</h1>
    <p class="sub">Listado sincronizado con el aforo (solo CuentaAforo y excluye “Visita”).</p>

    <div class="row">
      <button id="refreshBtn">Actualizar ahora</button>
      <span id="status" class="sub">Esperando datos…</span>
      <span id="led" class="led"></span>
      <span class="pill">Total dentro: <b id="total">0</b></span>
    </div>

    <div class="grid" id="grid"></div>

    <div class="footer" id="updated">Actualizado: —</div>
  </div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbxwXPZt7vKDBnpN1yhb5DYjzaeKNvEhrneTgsZQRBN0Mlv7z6CX_gUN0cHaJkUx2VMI/exec"; // <-- CAMBIA ESTO
  const REFRESH_MS = 15000;

  const CUARTELES = ["Cuartel 1","Cuartel 2","Cuartel 3","Cuartel General"];

  const LOGOS = {
    "Cuartel 1": "img/c1.png",
    "Cuartel 2": "img/c2.png",
    "Cuartel 3": "img/c3.png",
    "Cuartel General": "img/cg.png",
  };

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      window[cb] = (data)=>{ resolve(data); try{ delete window[cb]; }catch{} };
      const s = document.createElement('script');
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
      s.onerror = ()=> reject(new Error('JSONP error'));
      document.body.appendChild(s);
      setTimeout(()=>{ try{s.remove()}catch{} }, 12000);
    });
  }

  const el = {
    grid: document.getElementById("grid"),
    status: document.getElementById("status"),
    led: document.getElementById("led"),
    updated: document.getElementById("updated"),
    total: document.getElementById("total"),
    btn: document.getElementById("refreshBtn")
  };

  function buildCards(){
    el.grid.innerHTML = "";
    CUARTELES.forEach(cu=>{
      const card = document.createElement("div");
      card.className = "card";

      const logo = LOGOS[cu] || "img/logocuerpo.png";

      card.innerHTML = `
        <div class="head">
          <img class="logo-cu" src="${logo}" alt="${cu}">
          <div class="title">
            <div class="label">${cu}</div>
            <div class="count"><span id="cnt-${cu}">0</span> <span class="label">dentro</span></div>
          </div>
        </div>
        <div class="list" id="list-${cu}">
          <div class="label">—</div>
        </div>
      `;
      el.grid.appendChild(card);
    });
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function renderList(container, arr){
    container.innerHTML = "";
    if (!arr || arr.length === 0){
      const empty = document.createElement("div");
      empty.className = "label";
      empty.textContent = "— Sin presentes —";
      container.appendChild(empty);
      return;
    }

    arr.forEach(p=>{
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="name">${escapeHtml(p.nombre || "Sin nombre")}</div>
        <div class="meta">
          ${escapeHtml(p.cargo || "")}
          ${p.motivo ? " • Motivo: " + escapeHtml(p.motivo) : ""}
          ${(p.fecha || p.hora) ? " • Último registro: " + escapeHtml((p.fecha||"") + " " + (p.hora||"")) : ""}
        </div>
      `;
      container.appendChild(item);
    });
  }

  async function loadPresentes(){
    try{
      el.status.textContent = "Actualizando…";
      el.led.classList.remove("bad"); el.led.classList.add("ok");

      const data = await jsonp(API_BASE + "?op=presentes");
      const por = data.porCuartel || {};
      el.total.textContent = data.total || 0;

      CUARTELES.forEach(cu=>{
        const arr = por[cu] || [];
        const cnt = document.getElementById("cnt-" + cu);
        const list = document.getElementById("list-" + cu);
        if (cnt) cnt.textContent = arr.length;
        if (list) renderList(list, arr);
      });

      el.updated.textContent = "Actualizado: " + (data.updated || new Date().toLocaleString("es-CL"));
      el.status.textContent = "OK";
    }catch(err){
      console.error(err);
      el.status.textContent = "Error";
      el.led.classList.remove("ok"); el.led.classList.add("bad");
    }
  }

  el.btn.addEventListener("click", loadPresentes);

  (async function init(){
    buildCards();
    await loadPresentes();
    setInterval(loadPresentes, REFRESH_MS);
  })();
</script>
</body>
</html>
